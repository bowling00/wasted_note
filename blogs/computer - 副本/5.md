# 运输层
运输层的两种协议：面向连接的TCP和面向无连接的UDP。
## 运输层端口号
### 服务器端使用的端口号
- **熟知的端口号**：**0~1023**，IANA把这些端口号指派给TCP/IP体系中最重要的一些应用协议，例如：FTP使用21/20，HTTP使用80，DNS使用53，
- **登记端口号**：**1024~49151**，为没有熟知的端口号使用。使用这类端口号必须在IANA按照规定的手续登记，以防止重复。
### 客户端使用的端口号
- **短暂端口号**：**4912~65535**，留给各户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其它客户进程以后使用。

::: tip
IP 层的 ip 地址可以唯一标识主机，而 TCP 层协议和端口号可以唯一标识主机的一个进程，这样我们可以利用：「ip地址＋协议＋端口号」唯一标示网络中的一个进程。在一些场合，也把这种唯一标识的模式称为「套接字 (Socket)」
:::

### 运输层熟知端口号
<img :src="$withBase('/computer/026.png')"></img>
### IP复用、分用
<img :src="$withBase('/computer/027.png')"></img>

## UDP
- UDP是无连接的
- UDP使用尽最大努力交付，即不保证可靠交付
- UDP是面向报文的
- UDP没有拥塞控制
- UDP支持一对一、一对多、多对一和多对多的交互通信
- UDP首部开销小
:::tip
UDP之间的通信要用到其端口号，但由于UDP的通信是无连接的，因此不需要使用套接字来建议连接（TCP需要）。
:::

## TCP
- 面向连接的运输层协议
- TCP连接只能点对点（一对一）
- TCP提供可靠交付的服务
- TCP提供全双工通信
- 面向子节流
## TCP可靠传输的实现
- 虽然发送发的发送窗口是根据接收方的接收窗口设置的，但在同一时刻，两个窗口的大小并不一定一样，因为网络传送窗口的值需要经历一定的时间滞后，并且发送方会根据网络的拥塞程度调整窗口的大小。
- 对于不按序到达数据如何处理，TCP并无明确规定。如果将无序的直接丢弃，那么接收窗口的实现比较简单，但会重复传递很多数据，TCP通常讲不按序到达的数据先临时放到接收窗口中，等到接收窗口缺少的字节收到之后，再按序交付到上层的应用进程。
T- CP要求接收方必须要有累计确认和稍待确认机制，这样可以减小传输开销。接收方可以在自己要发送数据的时候把确认信息捎带上。TCP标准规定，确认推迟的时间不应该超过0.5秒。稍待确认很少发生。
- TCP的通信是全双工通信。
## TCP的连接建立
- TCP是面向连接的协议，它基于运输连接来传送TCP报文段。
- TCP的连接的建立和释放是每一次面向连接必不可少的过程。
- 三个阶段：
  - 建立TCP连接
  - 数据传送
  - 释放TCP连接
  - TCP的运输连接管理就是使连接的建立和释放都能正常地进行。
## 需要解决的三个问题
- 使TCP双方能够确知对方的存在；
- 使TCP双方能够协商一些参数；
- 使TCP双方能够对运输实体资源进行分配。
## ARQ
发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。
## TCP报文段的首部格式
<img :src="$withBase('/computer/031.png')"></img>
### 源端口
16比特，标识发送该TCP报文段的应用进程；
### 目的端口
16比特，标识接受该TCP报文段的应用进程。
### 序号
在一个TCP连接中传送的子节流中的每一个字节都按顺序编号
### 确认号
是期望收到对方下一个报文段的第一个数据字节的序号。同时也是对之前的所有数据的确认。
<img :src="$withBase('/computer/028.png')"></img>
### 数据偏移
占4比特，以四字节为单位，指出TCP报文段首部的长度。最小值为5，最大为15。
### 窗口
占16比特，以字节为单位。指出发送本报文段的一方的接收窗口。
### 校验和
检查范围是首部和数据载荷两部分。
### 确认ACK
仅当AC=1时确认号字段才有效。取值为零时无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。
### 推送PSH
推送标志位，接收方的TCP收到该标志位为1的报文段会尽快上交应用进程，而不必等到接受缓存都填满后再向上交付。
当两个应用进程进行交互式的通信时,有时在一端的应用进性希望在键入一个命令后立即就能够收到对方的响应，在这种情况下,TCP就可以使用推送(pusb)操作。这时,发送方 TCP 把 PSH 置1,并立即创建一个报文段发送出去。接收方在收到PSH=1的报文段，就尽快地交付接受应用进程，而不再等到整个缓存都填满了后再向上交付。

### 复位RST
当RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后重新建立运输连接。
### 同步SYN
同步标志位，在TCP连接建立时用来同步序号
在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在相应的报文段中使SYN=1和ACK=1。因此SYN置为1就表示这是一个连接请求或连接接受报文。
### 终止FIN
用来释放一个连接。当 FIN=1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。
### URG
紧急标志位，取值为1时紧急指针字段有效；取值为零时无效。
选项：

- 最大报文段长度MSS选项：TCP报文段数据载荷部分的最大长度。
- 窗口扩大选项：为了扩大窗口（提高吞吐率）。
- 时间戳选项：用来计算往返时间RTT，用来处理序号超范围的情况，又称为防止序号绕回PAWS
- 选择确认功能
## TCP使用“三报文握手”建立连接
![image-20220103081448967](C:\Users\alan\AppData\Roaming\Typora\typora-user-images\image-20220103081448967.png)
SYN：同步位，表明这是一个TCP连接请求报文段。

seq：发送到哪个序号

ACK：确认位

ack：确认号字段，对发送方某一位置的确认

TCP的标准规定，SYN = 1的报文段不能携带数据，也要消耗掉一个序号。
TCP的标准规定，普通的确认报文段如果不携带数据，则不消耗数据。

## TCP通过“四次报文挥手”来释放连接
![image-20220103081405242](C:\Users\alan\AppData\Roaming\Typora\typora-user-images\image-20220103081405242.png)
FIN：终止位，表明这是一个TCP的终止请求

TCP的标准规定，FIN = 1的报文段不能携带数据，也要消耗掉一个序号。

### TCP流量控制

一般来说，我们总是希望数据传的快一些。但如果发送方传的过快会造成数据丢失。
所谓流量控制就是不让发送方发的太快，让接收方来得及接收。
利用滑动窗口可以很方便地在TCP连接上实现对发送方流量的控制
TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小。
TCP发送方收到接收方的零窗口通知后，应启动持续计时器。持续计时器超时后，向接收方发送零口探测报文。

### TCP的拥塞控制
![image-20220103081552032](C:\Users\alan\AppData\Roaming\Typora\typora-user-images\image-20220103081552032.png)


