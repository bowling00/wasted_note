---
title: 计网-网络层
date: 2022-01-01 21:00:00
tags: 
	- 计算机网络
categories: 
	- 计算机基础
---

# 网络层

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。
网络层不提供服务质量的承诺，如果需要的通信是可靠的，则需要运输层负责。

## 四种协议关系

- IP 协议:实现网络万连。使参与互.连的性能各异的网络从用户看起来好像是一个统一的网络。网际协议 IP 是 TCP/IP 体系中两个最主:要的协议之一，与 IP 协议配套使用的还有四个协议。
- 地址解析协议 ARP，是解决同一个局域网上的主机或路由器的 P 地址和硬件地址的映射问题。
- 网际控制报文协议 ICMP，提供差错报告和询问报文，以提高 IP 数据交付成功的机会
- 网际组管理协议 IGMP，用于探寻、转发本局域网内的组成员关系

下层为上层提供服务，如图所示，ARP 为 IP 服务，ip 为 ICMP 和 IGMP 服务

<img :src="$withBase('/computer/021.png')"></img>

## 网络互联设备

物理层使用的中间设备叫**转发器**。
数据链路层使用的中间设备叫**网桥**或**桥接器**。
网络层使用的中间设备叫**路由器**。
在网络层以上使用的设备叫网关。
由于历史的原因，许多有关 TCP/IP 的文献曾把网络层使用的路由器称为网关

## 分类的 IP 地址

IP 地址的编址方法经过三个阶段:分类的 IP 地址、子网的划分、构成超网。
<img :src="$withBase('/computer/022.png')"></img>

## 划分子网的 IP 地址

<img :src="$withBase('/computer/023.png')"></img>

## ARP

通常把 ARP 协议划归为网络层，但 ARP 协议的**用途**是为了**从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。**

### 实现方法

在主机 ARP 管束缓存中存放一个从 IP 地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。

### 例子

当主机 A 要向本局域网上的某台主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存表中查看有无主机 B 的 IP 地址，如果有就在 ARP 告诉缓存中查出其相应的硬件地址，再把这个硬件地址写入 MAC 帧,然后通过局域网把该 MAC 帧发往此硬件地址。

## 分片

1、一个 3200 位长的 TCP 报文传到 IP 层，加上 160 位的首部后成为数据报。下面的互联网由两个局域网通过路由器连接起来。但第二个局域网所能传送的最长数据帧中的数据部分只有 1200 位。因此数据报在路由器必须进行分片。试问第二个局域网向其上层要传送多少比特的数据（这里的“数据”当然指的是局域网看见的数据）?

答：第二个局域网所能传送的最长数据帧中的数据部分只有 1200bit，即每个 IP 数据片的数据部分<1200-160(bit)，由于片偏移是以 8 字节即 64bit 为单位的，所以 IP 数据片的数据部分最大不超过 1024bit，这样 3200bit 的报文要分 4 个数据片，所以第二个局域网向上传送的比特数等于（3200+4×160），共 3840bit。

---

2、（1）有人认为：“ARP 协议向网络层提供了转换地址的服务，因此 ARP 应当属于数据链路层。”这种说法为什么是错误的？

因为 ARP 本身是网络层的一部分，ARP 协议为 IP 协议提供了转换地址的服务，数据链路层使用硬件地址而不使用 IP 地址，无需 ARP 协议数据链路层本身即可正常运行。因此 ARP 不再数据链路层。

（2）试解释为什么 ARP 高速缓存每存入一个项目就要设置 10~20 分钟的超时计时器。这个时间设置的太大或太小会出现什么问题？

答：考虑到 IP 地址和 Mac 地址均有可能是变化的（更换网卡，或动态主机配置）
10－20 分钟更换一块网卡是合理的。超时时间太短会使 ARP 请求和响应分组的通信量太频繁，而超时时间太长会使更换网卡后的主机迟迟无法和网络上的其他主机通信。

（3）至少举出两种不需要发送 ARP 请求分组的情况（即不需要请求将某个目的 IP 地址解析为相应的硬件地址）。

在源主机的 ARP 高速缓存中已经有了该目的 IP 地址的项目；源主机发送的是广播分组；源主机和目的主机使用点对点链路。

## 分组转发流程

设某路由器建立了如下路由表：
| 目的网络 | 子网掩码 | 下一跳 |
| ------------- | --------------- | ------ |
| 128.96.39.0 | 255.255.255.128 | 接口 m0 |
| 128.96.39.128 | 255.255.255.128 | 接口 m1 |
| 128.96.40.0 | 255.255.255.128 | R2 |
| 192.4.153.0 | 255.255.255.192 | R3 |
| \*（默认） | — | R4 |
<pre style="color:white">
现共收到 5 个分组，其目的地址分别为：
（1）128.96.39.10
（2）128.96.40.12
（3）128.96.40.151
（4）192.153.17
（5）192.4.153.90
（1）分组的目的站 IP 地址为：128.96.39.10。先与子网掩码 255.255.255.128 相与，得 128.96.39.0，可见该分组经
     接口0 转发。
（2）分组的目的 IP 地址为：128.96.40.12。
    ①与子网掩码 255.255.255.128 相与得 128.96.40.0，不等于 128.96.39.0。
    ② 与子网掩码 255.255.255.128 相与得 128.96.40.0，经查路由表可知，该项分组经 R2 转发。
（3）分组的目的 IP 地址为：128.96.40.151，与子网掩码 255.255.255.128 相与后得 128.96.40.128，
    与子网掩码 255.255.255.192 相与后得 128.96.40.128，经查路由表知，该分组转发选择默认路由，经 R4 转发。
（4）分组的目的 IP 地址为：192.4.153.17。与子网掩码 255.255.255.128 相与后得 192.4.153.0。
    与子网掩码 255.255.255.192 相与后得 192.4.153.0，经查路由表知，该分组经 R3 转发。
（5）分组的目的 IP 地址为：192.4.153.90，与子网掩码 255.255.255.128 相与后得 192.4.153.0。
   与子网掩码 255.255.255.192 相与后得 192.4.153.64，经查路由表知，该分组转发选择默认路由，经 R4 转发。
</pre>
## 计算网络地址、可分配 IP 地址数、起止地址

已知某主机的 IP 地址为 180.25.150.22/21,试写出该主机所接网络的网络地址,子网掩码,网络内可分配的 IP 地址数和可用的起止 IP 地址。

答案：
<p>网络地址：180.25.140.0</p><p>子网掩码：255.255.248.0</p><p>可分配IP地址数：2046个</p><p>第一个可用IP地址：180.25.140.1</p><p>最后一个可用IP地址：180.25.151.254</p>
## 划分子网

<pre style="color:white">
某单位分配到一个地址块136.23.12.64/26。现在需要进一步划分为4个一样大的子网。试问:
       （1）每一个子网的网络前缀有多长？
       （2）每一个子网中有多少个地址？
       （3）每一个子网的地址是什么？
       （4）每一个子网可分配给主机使用的最小地址和最大地址是什么？
（1）每个子网前缀28位。
（2）每个子网的地址中有4位留给主机用，因此共有16个地址。
（3）四个子网的地址块是：
第一个地址块136.23.12.64/28，可分配给主机使用的
   最小地址：136.23.12.01000001＝136.23.12.65/28
   最大地址：136.23.12.01001110＝136.23.12.78/28
第二个地址块136.23.12.80/28，可分配给主机使用的
   最小地址：136.23.12.01010001＝136.23.12.81/28
   最大地址：136.23.12.01011110＝136.23.12.94/28
第三个地址块136.23.12.96/28，可分配给主机使用的
   最小地址：136.23.12.01100001＝136.23.12.97/28
   最大地址：136.23.12.01101110＝136.23.12.110/28
第四个地址块136.23.12.112/28，可分配给主机使用的
   最小地址：136.23.12.01110001＝136.23.12.113/28
   最大地址：136.23.12.01111110＝136.23.12.126/28
</pre>
## ICMP应用例子
### PING的作用
### tracert的作用
## 距离向量算法
<pre style="color:white">
假定网络中的路由器B的路由表有如下的项目（这三列分别表示“目的网络”、“距离”和“下一跳路由器”）
                  N1        7        A
                  N2        2        B
                  N6        8        F
                  N8        4        E
                  N9        4        F
现在B收到从C发来的路由信息（这两列分别表示“目的网络”“距离”）：
                  N2        4
                  N3        8
                  N6        4
                  N8        3
                  N9        5
试求出路由器B更新后的路由表（详细说明每一个步骤）。
  路由器B更新后的路由表如下：
    N1　　　7　　A　　　　无新信息，不改变
    N2　　　5　　C　　　　相同的下一跳，更新
    N3　　　9　　C　　　　新的项目，添加进来
    N6　　　5　　C　　　　不同的下一跳，距离更短，更新
    N8　　　4　　E　　　　不同的下一跳，距离一样，不改变
    N9　　　4　　F　　　　不同的下一跳，距离更大，不改变
</pre>
## IPV6地址位数
IPV6使用冒号十六进制记法，8位
## VPN
利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN
## NAT的作用
内网机能上公网
NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源。
通过路由器安装NAT软件，达到将私有地址转变为共有地址的目的。
<img :src="$withBase('/computer/024.png')"></img>
每个私有IP通过路由器的时候都会将私有IP转换为公有IP，为了访问之后回来还能找到这个私有IP，还需要维护一个对应表，所以使得同一时刻，最多只能有路由器拥有的公有IP数目个私有IP主机进行因特网访问。

由于绝大多数的网络应用都是使用运输层协议TCP或UDP来传送数据，因此可以利用运输层的端口号和IP得知一起进行转换，这样用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信，这种将端口号和IP地址一起转换的技术成为网络地址与端口号转换NSPT。
<img :src="$withBase('/computer/025.png')"></img>
